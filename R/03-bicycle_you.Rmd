---
title: "Bicycle"
output: github_document
---

**Collapse all chunks with Alt+O / Cmd+Option+O**



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, comment = "#>")
```

Packages.

```{r}
library(tidyverse)
library(here)
library(vroom)
library(fs)
library(glue)
```



This messy dataset comes in multiple files -- one per continent:

```{r demo-paths}
paths <- dir_ls(here("data", "by-continent"))
paths
```

You can use `map_df()` to interactively call `read_csv()` on each path.

```{r message=FALSE}
paths %>% map_df(read_csv)
```

But `vroom()` does this faster and in one step (it's "vectorized" over `file`).



* Read the data from all `paths` into a single data frame with `vroom()`.
* Store the result as `messy` and `glimpse()` it.

```{r vroom-messy-1}


```

```{r vroom-messy-2, eval=FALSE}
messy <- _____(paths)
messy %>% _______()
```

```{r vroom-messy-3, echo=FALSE}
messy <- vroom(paths)
messy %>% glimpse()
```



This messy dataset is hard to work with but not impossible. Let's study the mean life expectancy through time.

Let's focus on `continent` and all columns that `start_with()` "lifeExp":

```{r start-with-3, echo=FALSE}
life_exp <- messy %>% 
  select(continent, starts_with("lifeExp_"))

life_exp
```

The prefix "lifeExp" is redundant and we could remove it.

```{r}
remove_prefix <- function(.x) str_replace(.x, "lifeExp_", "")

life_exp1 <- life_exp %>% 
  rename_with(remove_prefix)

# Same with the `~` shortcut, like in `map()` and friends
life_exp1 <- life_exp %>% 
  rename_with(~str_replace(.x, "lifeExp_", ""))

life_exp1
```

(The resulting names are non-syntactic so R surrounds them in backticks. Such names are awkward and you should avoid them. As you will soon see, here we won't refer to them directly; instead we'll use the tidyselect helpers -- see `?select()`.)



* Use `summarize()` to get the `mean` `across()` all columns except `continent`.

```{r summarize-across-1}


```

```{r summarize-across-2, eval=FALSE}
life_exp1 %>% 
  _________(across(-_________, mean))
```

```{r summarize-across-3, echo=FALSE}
life_exp1 %>% 
  summarize(across(-continent, mean))
```



* Now iterate over each continent, by grouping column-wise with `group_by()`.
* Store the result as `by_continent`.

```{r summarise-group-by-1}





```

```{r summarise-group-by-2, eval=FALSE}
by_continent <- life_exp1 %>% 
  ________(continent) %>% 
  summarize(______(everything(), ____))

by_continent
```

```{r summarise-group-by-3, echo=FALSE}
by_continent <- life_exp1 %>% 
  group_by(continent) %>% 
  summarize(across(everything(), mean))

by_continent
```



* Now iterate over each year, by grouping row-wise with `rowwise()`.
* Create the new column `life_expectancy`, and inside `mean()` access tidyselect syntax with `c_across()` -- which defaults to `everything()`.

```{r summarize-rowwise-1}
total <- by_continent %>% 
  rowwise(continent) %>% 
  summarise(life_expectancy = mean(c_across(everything())))

total
```

```{r summarize-rowwise-2, eval=FALSE}
total <- by_continent %>% 
  _______(continent) %>% 
  summarise(life_expectancy = mean(c_______()))

total
```

```{r summarize-rowwise-3, echo=FALSE}
total <- by_continent %>% 
  rowwise(continent) %>% 
  summarise(life_expectancy = mean(c_across()))

total
```



* Create a bar-plot (`?geom_col()`) of `continent` versus `life_expectancy`.
* Add a title with `labs()`; it should read "Mean life expectancy (1952-2007)".
* Create the title combining text and code output with `glue()`.
* Get the `first()` and `last()` year from the dataset `names()`.

```{r geom-col-1}








```

```{r geom-col-2, eval=FALSE}
year <- by_continent %>% select(-continent) %>% names()
plot_title <- ____("Mean life expectancy ({first(____)}-{____(year)})")

total %>% 
  ggplot(aes(continent, life_expectancy)) +
  geom_col() +
  labs(title = plot_title)
```

```{r geom-col-3, echo=FALSE}
year <- by_continent %>% select(-continent) %>% names()
plot_title <- glue("Mean life expectancy ({first(year)}-{last(year)})")

total %>% 
  ggplot(aes(continent, life_expectancy)) +
  geom_col() +
  labs(title = plot_title)
```

That was hard work. R is column-oriented so it's best to first tidy the data.

